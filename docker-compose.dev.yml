services:
  # Express Backend Server (Development)
  server:
    build:
      context: .
      dockerfile: apps/server/Dockerfile.dev
    container_name: app-server-dev
    ports:
      - "4000:4000"
    env_file:
      - ./apps/server/.env
    environment:
      - NODE_ENV=development
      - PORT=4000
    volumes:
      # Mount source code for hot reloading
      - ./apps/server:/app/apps/server
      - ./packages:/app/packages
      - ./package.json:/app/package.json
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml
      - ./turbo.json:/app/turbo.json
      # Preserve node_modules
      - server-node-modules:/app/node_modules
      - server-app-node-modules:/app/apps/server/node_modules
    networks:
      - app-network
    command: pnpm --filter server dev

  # Web Frontend App (Development)
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
    container_name: app-web-dev
    env_file:
      - ./apps/web/.env.local
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - API_URL=http://server:4000
      - NEXT_PUBLIC_API_URL=http://localhost:4000
      - NEXT_PUBLIC_SITE_URL=http://localhost:3000
    volumes:
      # Mount source code for hot reloading
      - ./apps/web:/app/apps/web
      - ./packages:/app/packages
      - ./package.json:/app/package.json
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml
      - ./turbo.json:/app/turbo.json
      # Preserve node_modules
      - web-node-modules:/app/node_modules
      - web-app-node-modules:/app/apps/web/node_modules
      # Next.js cache
      - web-next-cache:/app/apps/web/.next
    networks:
      - app-network
    depends_on:
      - server
    command: pnpm --filter web dev

  # Admin Frontend App (Development)
  admin:
    build:
      context: .
      dockerfile: apps/admin/Dockerfile.dev
    container_name: app-admin-dev
    env_file:
      - ./apps/admin/.env.local
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - API_URL=http://server:4000
      - NEXT_PUBLIC_API_URL=http://localhost:4000
    volumes:
      # Mount source code for hot reloading
      - ./apps/admin:/app/apps/admin
      - ./packages:/app/packages
      - ./package.json:/app/package.json
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml
      - ./turbo.json:/app/turbo.json
      # Preserve node_modules
      - admin-node-modules:/app/node_modules
      - admin-app-node-modules:/app/apps/admin/node_modules
      # Next.js cache
      - admin-next-cache:/app/apps/admin/.next
    networks:
      - app-network
    depends_on:
      - server
    command: pnpm --filter admin dev

networks:
  app-network:
    driver: bridge
    name: app-network-dev

volumes:
  server-node-modules:
  server-app-node-modules:
  web-node-modules:
  web-app-node-modules:
  web-next-cache:
  admin-node-modules:
  admin-app-node-modules:
  admin-next-cache:
